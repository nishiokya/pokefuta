# ãƒã‚±ãµãŸç®¡ç†ãƒ„ãƒ¼ãƒ«

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### `generate_manhole_sql.py`

æœ€æ–°ã®ãƒã‚±ãµãŸãƒ‡ãƒ¼ã‚¿ã‚’GitHubã‹ã‚‰å–å¾—ã—ã€PostgreSQL INSERTæ–‡ã‚’ç”Ÿæˆã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚

## ğŸš€ ä½¿ã„æ–¹

### 1. ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®SQLç”Ÿæˆ

#### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
# å…¨ä»¶SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
python3 tools/generate_manhole_sql.py > manhole_data.sql

# Supabase SQL Editorã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ¨™æº–å‡ºåŠ›ã®ã¿ã‚’ä¿å­˜
python3 tools/generate_manhole_sql.py 2>/dev/null > manhole_data.sql

# ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
python3 tools/generate_manhole_sql.py --help
```

#### IDç¯„å›²ã‚’æŒ‡å®šã—ã¦ç”Ÿæˆ

```bash
# ID 100ä»¥ä¸‹ã®ã¿å‡ºåŠ›
python3 tools/generate_manhole_sql.py --max-id 100 > manhole_data.sql

# ID 50ã‹ã‚‰100ã¾ã§å‡ºåŠ›
python3 tools/generate_manhole_sql.py --min-id 50 --max-id 100 > manhole_data.sql

# ID 200ä»¥ä¸Šã®ã¿å‡ºåŠ›ï¼ˆæ–°è¦è¿½åŠ åˆ†ã®ã¿ï¼‰
python3 tools/generate_manhole_sql.py --min-id 200 > new_manholes.sql

# ID 1ã‹ã‚‰10ã¾ã§å‡ºåŠ›ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
python3 tools/generate_manhole_sql.py --min-id 1 --max-id 10 > test_data.sql
```

### 2. Supabaseã«é©ç”¨

1. ç”Ÿæˆã•ã‚ŒãŸ `manhole_data.sql` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
2. Supabase Dashboard > SQL Editor ã‚’é–‹ã
3. SQLã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã—ã¦å®Ÿè¡Œ

ã¾ãŸã¯ã€`psql`ã‚³ãƒãƒ³ãƒ‰ã§ç›´æ¥é©ç”¨:

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export DATABASE_URL="postgresql://user:password@host:port/database"

# SQLã‚’é©ç”¨
python tools/generate_manhole_sql.py 2>/dev/null | psql $DATABASE_URL
```

## ğŸ“Š å‡ºåŠ›å½¢å¼

### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

```sql
CREATE TABLE IF NOT EXISTS public.manhole (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title TEXT,
  prefecture TEXT,
  municipality TEXT,
  location GEOGRAPHY,                        -- PostGISå‹
  pokemons TEXT[],
  detail_url TEXT,
  source_last_checked TIMESTAMPTZ,           -- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æœ€çµ‚ç¢ºèªæ—¥æ™‚
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**æ³¨æ„:** æ—¢å­˜ã®Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ã¦ã„ã¾ã™ã€‚

### INSERTæ–‡ã®ç‰¹å¾´

- **ON CONFLICT DO UPDATE**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•æ›´æ–°
- **PostGIS POINT**: ä½ç½®æƒ…å ±ã¯ `ST_GeogFromText` ã§æ­£ç¢ºã«æ ¼ç´
- **é…åˆ—å‹**: ãƒã‚±ãƒ¢ãƒ³åã¯ `TEXT[]` é…åˆ—ã§æ ¼ç´
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: `updated_at` ã¯è‡ªå‹•æ›´æ–°

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®æµã‚Œ

```mermaid
graph LR
    A[GitHub pokefuta.ndjson] --> B[Python Script]
    B --> C[SQL INSERTæ–‡ç”Ÿæˆ]
    C --> D[Supabase SQL Editor]
    D --> E[PostgreSQL Database]
```

## ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

- **GitHub Repository**: https://github.com/nishiokya/pokefuta-tracker
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/scraper/pokefuta.ndjson`
- **æ›´æ–°é »åº¦**: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã«ã‚ˆã‚Šå®šæœŸçš„ã«æ›´æ–°

## âš ï¸ æ³¨æ„äº‹é …

1. **Python 3.6ä»¥ä¸ŠãŒå¿…è¦**
2. **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦**ï¼ˆGitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯æ›´æ–°ã•ã‚Œã‚‹**ï¼ˆON CONFLICT DO UPDATEï¼‰
4. **PostGISæ‹¡å¼µãŒå¿…è¦**ï¼ˆSupabaseã§ã¯æ¨™æº–ã§æœ‰åŠ¹ï¼‰

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: `urllib.error.URLError`

â†’ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„

### ã‚¨ãƒ©ãƒ¼: `JSON decode error`

â†’ NDJSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

### ã‚¨ãƒ©ãƒ¼: `ST_GeogFromText does not exist`

â†’ PostGISæ‹¡å¼µãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:

```sql
CREATE EXTENSION IF NOT EXISTS postgis;
```

## ğŸ’¡ ä½¿ç”¨ä¾‹

### æ–°è¦ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã®ã¿ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ—¢ã«400ä»¶ã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã€ID 401ä»¥ä¸Šã®ã¿ã‚’è¿½åŠ ï¼š

```bash
# ID 401ä»¥ä¸Šã®æ–°è¦ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã®ã¿ç”Ÿæˆ
python3 tools/generate_manhole_sql.py --min-id 401 > new_manholes.sql

# ä½•ä»¶å‡ºåŠ›ã•ã‚Œã‚‹ã‹ç¢ºèª
python3 tools/generate_manhole_sql.py --min-id 401 2>&1 | grep "å®Œäº†"
```

### ç‰¹å®šã®ç¯„å›²ã®ã¿ã‚’æ›´æ–°ã™ã‚‹å ´åˆ

ID 1-100ã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«æƒ…å ±ã®ã¿ã‚’æ›´æ–°ï¼š

```bash
# ID 1-100ã®ã¿ç”Ÿæˆ
python3 tools/generate_manhole_sql.py --min-id 1 --max-id 100 > update_first_100.sql
```

### ãƒ†ã‚¹ãƒˆç”¨ã«å°‘é‡ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ

```bash
# æœ€åˆã®10ä»¶ã®ã¿ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
python3 tools/generate_manhole_sql.py --max-id 10 > test_data.sql
```

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [PostGIS Documentation](https://postgis.net/documentation/)
- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Arrays](https://www.postgresql.org/docs/current/arrays.html)
