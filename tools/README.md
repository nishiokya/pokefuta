# ポケふた管理ツール

## 📁 ファイル一覧

### `generate_manhole_sql.py`

最新のポケふたデータをGitHubから取得し、PostgreSQL INSERT文を生成するPythonスクリプト。

## 🚀 使い方

### 1. マンホールデータのSQL生成

#### 基本的な使い方

```bash
# 全件SQLファイルを生成
python3 tools/generate_manhole_sql.py > manhole_data.sql

# Supabase SQL Editorで実行するために標準出力のみを保存
python3 tools/generate_manhole_sql.py 2>/dev/null > manhole_data.sql

# ヘルプを表示
python3 tools/generate_manhole_sql.py --help
```

#### ID範囲を指定して生成

```bash
# ID 100以下のみ出力
python3 tools/generate_manhole_sql.py --max-id 100 > manhole_data.sql

# ID 50から100まで出力
python3 tools/generate_manhole_sql.py --min-id 50 --max-id 100 > manhole_data.sql

# ID 200以上のみ出力（新規追加分のみ）
python3 tools/generate_manhole_sql.py --min-id 200 > new_manholes.sql

# ID 1から10まで出力（テスト用）
python3 tools/generate_manhole_sql.py --min-id 1 --max-id 10 > test_data.sql
```

### 2. Supabaseに適用

1. 生成された `manhole_data.sql` ファイルを開く
2. Supabase Dashboard > SQL Editor を開く
3. SQLをコピー&ペーストして実行

または、`psql`コマンドで直接適用:

```bash
# 環境変数を設定
export DATABASE_URL="postgresql://user:password@host:port/database"

# SQLを適用
python tools/generate_manhole_sql.py 2>/dev/null | psql $DATABASE_URL
```

## 📊 出力形式

### テーブル構造

```sql
CREATE TABLE IF NOT EXISTS public.manhole (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title TEXT,
  prefecture TEXT,
  municipality TEXT,
  location GEOGRAPHY,                        -- PostGIS型
  pokemons TEXT[],
  detail_url TEXT,
  source_last_checked TIMESTAMPTZ,           -- データソース最終確認日時
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**注意:** 既存のSupabaseデータベーススキーマに合わせています。

### INSERT文の特徴

- **ON CONFLICT DO UPDATE**: 既存データは自動更新
- **PostGIS POINT**: 位置情報は `ST_GeogFromText` で正確に格納
- **配列型**: ポケモン名は `TEXT[]` 配列で格納
- **タイムスタンプ**: `updated_at` は自動更新

## 🔄 データ更新の流れ

```mermaid
graph LR
    A[GitHub pokefuta.ndjson] --> B[Python Script]
    B --> C[SQL INSERT文生成]
    C --> D[Supabase SQL Editor]
    D --> E[PostgreSQL Database]
```

## 📝 データソース

- **GitHub Repository**: https://github.com/nishiokya/pokefuta-tracker
- **データファイル**: `apps/scraper/pokefuta.ndjson`
- **更新頻度**: スクレイパーにより定期的に更新

## ⚠️ 注意事項

1. **Python 3.6以上が必要**
2. **インターネット接続が必要**（GitHubからデータ取得）
3. **既存データは更新される**（ON CONFLICT DO UPDATE）
4. **PostGIS拡張が必要**（Supabaseでは標準で有効）

## 🛠️ トラブルシューティング

### エラー: `urllib.error.URLError`

→ インターネット接続を確認してください

### エラー: `JSON decode error`

→ NDJSONファイルの形式が壊れている可能性があります

### エラー: `ST_GeogFromText does not exist`

→ PostGIS拡張が有効になっているか確認してください:

```sql
CREATE EXTENSION IF NOT EXISTS postgis;
```

## 💡 使用例

### 新規マンホールのみを追加する場合

データベースに既に400件のマンホールがある場合、ID 401以上のみを追加：

```bash
# ID 401以上の新規マンホールのみ生成
python3 tools/generate_manhole_sql.py --min-id 401 > new_manholes.sql

# 何件出力されるか確認
python3 tools/generate_manhole_sql.py --min-id 401 2>&1 | grep "完了"
```

### 特定の範囲のみを更新する場合

ID 1-100のマンホール情報のみを更新：

```bash
# ID 1-100のみ生成
python3 tools/generate_manhole_sql.py --min-id 1 --max-id 100 > update_first_100.sql
```

### テスト用に少量データを生成

```bash
# 最初の10件のみ（開発・テスト用）
python3 tools/generate_manhole_sql.py --max-id 10 > test_data.sql
```

## 📚 参考リンク

- [PostGIS Documentation](https://postgis.net/documentation/)
- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Arrays](https://www.postgresql.org/docs/current/arrays.html)
